<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>HIB || Registration</title>
    <meta name="description" content="meta description">
    <meta name="author" content="author name">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/material-ui/4.12.1/index.js" integrity="sha512-FjkbKM7CNX2Q3JuUyWQZQyBuyhbZpAqvPpMJTI2m9ahkCcerrxKHZHvlV9EYufBZAy7EsvNh52dnoi7BNGC8Pw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.js" integrity="sha256-r/AaFHrszJtwpe+tHyNi/XCfMxYpbsRg2Uqn0x3s2zc=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-loading-overlay@3"></script>
    <link href="https://cdn.jsdelivr.net/npm/vue-loading-overlay@3/dist/vue-loading.css" rel="stylesheet">
    
    <script src="https://unpkg.com/vue-toasted"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vue-toasted/1.1.28/vue-toasted.min.css" integrity="sha512-P9tgFEUBcyvFHEXSRGLQB/SvGxnMfJCZGy4SBp+JIFgs1BSoYfUkadkZri9Rwkeh8Vg0lGo72X99o31wetRGCw==" crossorigin="anonymous" />

    <script src="https://cdn.jsdelivr.net/npm/vue-toast-notification"></script>
    <link href="https://cdn.jsdelivr.net/npm/vue-toast-notification/dist/theme-default.css" rel="stylesheet">


<style type="text/css">
    .btn-primary {
        color: #fff;
        background-color: #473cb3;
        border-color: #473cb3;
    }
    .your-custom-class {
            background-color: #59b460 !important; 
            }
            .v-select .dropdown-menu {
  display:block;
}
</style>
</head>

<body>

<div id="jpt">

    <div class="container mt-4">
        <div class="header">
            <div class="row mb-3">
                <div class="col-md-8 col-lg-8">
                    <img src="https://hib.gov.np/public/uploads/shares/logo.png" style="height: 100px; float: left;">
                    <div class="title" style="margin-left: 20px; float: left; margin-top: 20px;">
                        <p style="margin-bottom: 2px; color: #473cb3; font-size: 16px;">नेपाल सरकार</p>
                        <p style="margin-top: 2px; color: #473cb3; font-size: 20px;">स्वास्थ्य बीमा बोर्ड</p>
                    </div>
                    <div class="vl" style="border-left: 2px solid lightgrey; height: 50px; position: absolute; left: 31%; top: 50px;"></div>
                    <div class="slogan" style="margin-top: 40px; margin-left: 30px; float:left;">
                        <span style="color: #473cb3; font-size: 18px;">"तपाईको स्वास्थ्य हाम्रो अठोट"</span>
                    </div>
                </div>
                <div class="col-md-4 col-lg-4">
                    <img src="https://hib.gov.np/site/img/shs.png" style="height: 100px; float: right;">
                </div>
            </div>
        </div>


        <div class="displayInitial" v-if="displayInitial==1">
            <div class="row" style="text-align: center;">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            Online Registration
                        </div>
                        <div class="card-body">
                            Click <a href="#" @click="e=>{ displayInitial=0; displayForm=1; }">here</a> for online registration.
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            Track
                        </div>
                        <div class="card-body">
                            Click <a href="#" @click="e=>{ displayInitial=0; displayTracking=1; }">here</a> for tracking your registration status.
                        </div>
                    </div>
                </div>
            </div>


            <div class="row my-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            Helpline Area
                        </div>
                        <div class="card-body">
                            
                        </div>
                        <div class="card-footer">
                            *Email to us at info@hib.com.np for your feedback and suggestions.* 
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            Contact Number
                        </div>
                        <div class="card-body">
                            Toll Free No: 014200xxx
                        </div>
                        <div class="card-footer">
                            *Email to us at info@hib.com.np for your feedback and suggestions.* 
                        </div>
                    </div>
                </div>
            </div> 
        </div>

        <div class="displayTracking" v-if="displayTracking==1">
                <div class="row">
                        <h4 class="mt-4" style="text-align:center;">Track your Registration Status</h4>
                        <center>
                            <div class="col-md-4 my-4">
                                <label>Mobile Number</label>
                                <input type="text" class="form-control" name="mobile_number" v-model="phone_number" placeholder="Enter your mobile number">
                            </div>
            
                            <button type="Submit" class="btn btn-primary my-2" @click="e=>{displayTracking=0; displayForm=1; GetInsureeTempDetails({phone_number: phone_number})}">Submit</button>
                            <button type="Submit" class="btn btn-danger my-2" @click="e=>{displayInitial=1; displayTracking=0;}">Cancel</button>
                        </center>
                    </div> 
        </div>

        <div class="displayForm row" v-if="displayForm==1">
            <div>
                <h2> Application Status </h2>
                <div v-if="ModelStatus.isApproved" class="alert alert-success">Approved</div><div v-else class="alert alert-success">Not Approved</div>
                <div v-if="ModelStatus.isHold" class="alert alert-warning"> Your application isHold</div>
                <div v-if="ModelStatus.isRejected" class="alert alert-danger">Your application isRejected</div>
                <div v-if="ModelStatus.statusMessage" class="alert alert-primary"><b>Reason:</b> [[ModelStatus.statusMessage]]</div>
            </div>



                        <!-- Family with no Insuree -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            Family with no Insuree
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 col-sm-12 mb-3" v-if="false">
                                    <label for="firstName" class="form-check-label" style="margin-right: 15px;">Poverty</label>
                                    <input type="checkbox" class="form-check-input" id="poverty_id" v-model="Model.Family.Poverty" >
                                </div>
                                <div class="col-md-3 col-sm-12">
                                    <label for="familyType" class="form-label">Family Type</label>
                                    <select class="form-select" v-model="Model.Family.FamilyType">
                                        <option value="">-- Select Type --</option>
                                        <option value="C">Council</option>
                                        <option value="G">Organization</option>
                                        <option value="H">Household</option>
                                        <option value="O">Other</option>
                                        <option value="P">Priests</option>
                                        <option value="S">Students</option>
                                        <option value="T">Teachers</option>
                                    </select>
                                </div>
                                <div class="col-md-3 col-sm-12 mb-3">
                                    <label for="familyAddress" class="form-label">Family Address</label>
                                    <input type="text" class="form-control" id="familyaddress_id" placeholder="Address" v-model="Model.Family.FamilyAddress" >
                                </div>

                                <div class="col-md-3 col-sm-12 mb-3" v-if="false">
                                    <label for="ethnicity" class="form-label">Ethnicity</label>
                                    <input type="text" class="form-control" id="ethnicity_id" placeholder="Ethnicity" v-model="Model.Family.Ethnicity" >
                                </div>
                            </div>
                        </div>        
                    </div>
                </div>
            </div>
            <!-- /.Family with no Insuree -->

            <!-- Family Member Card -->
            <div class="row my-3">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row" v-for="(Insuree,index) in Model.Insurees">
                                <!-- Family Details -->
                                <div class="accordion" id="accordionFamily">
                                    <div class="accordion-item my-2">
                                        <h2 class="accordion-header" id="familyHead">
                                            <button class="accordion-button" v-if="index==0" type="button" data-bs-toggle="collapse" data-bs-target="#familyHead" aria-expanded="true" aria-controls="familyHead">
                                                Family Head
                                            </button>

                                            <button class="accordion-button" v-if="index!==0" type="button" data-bs-toggle="collapse" data-bs-target="#familyHead" aria-expanded="true" aria-controls="familyHead">
                                                Family Member
                                            </button>
                                        </h2>
                                        <div id="familyHead" class="accordion-collapse collapse show" aria-labelledby="familyHead" data-bs-parent="#accordionFamily">
                                            <div class="accordion-body">
                                                <!-- First Row -->
                                                <div class="row">
                                <template v-if="index==0">
                                    <div class="col-md-3 col-sm-6">
                                        <label for="region" class="form-label">Region</label>
                                        <select v-model="Insuree.RegionId" @change="e=>changeRegion(Insuree)" class="form-select">
                                            <option v-for="(item,index) in Selects.Regions" :value="item.id">[[item.name]]</option>
                                        </select>
                                    </div>

                                    <div class="col-md-3 col-sm-6">
                                        <label for="district" class="form-label">District</label>
                                        <select v-model="Insuree.DistrictId" @change="e=>changeDistrict(Insuree)" class="form-select">
                                            <option v-for="(item,index) in Insuree.SelectDistricts" :value="item.id">[[item.name]]</option>
                                        </select>
                                    </div>

                                    <div class="col-md-3 col-sm-6">
                                        <label for="municipality" class="form-label">Municipality</label>
                                        <select v-model="Insuree.MunId" @change="e=>changeMun(Insuree)" class="form-select">
                                            <option v-for="(item,index) in Insuree.SelectMuns" :value="item.id">[[item.name]]</option>
                                        </select>
                                    </div>

                                    <div class="col-md-3 col-sm-6">
                                        <label for="village" class="form-label">Village</label>
                                        <select v-model="Insuree.VillId" class="form-select">
                                            <option v-for="(item,index) in Insuree.SelectVillages" :value="item.id">[[item.name]]</option>
                                        </select>
                                    </div>

                                    <div class="col-md-3 col-sm-6">
                                        <label for="village" class="form-label">HealthFacility</label>
                                        <select v-model="Insuree.HFID" class="form-select">
                                            <option v-for="(item,index) in Insuree.SelectHealthFacility" :value="item.id">[[item.name]]</option>
                                        </select>
                                    </div>
                                </template>
                                                </div>
                                                <!-- /.First Row -->

                                                <!-- Second Row -->
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <label for="otherName" class="form-label">Other name</label>
                                                        <input type="text" class="form-control" id="otherName" placeholder="Other name" v-model="Insuree.OtherNames">
                                                    </div>

                                                    <div class="col-md-3">
                                                        <label for="lastName" class="form-label">Last name</label>
                                                        <input type="text" class="form-control" id="lastName" placeholder="Last name" v-model="Insuree.LastName">
                                                    </div>
                                                    
                                                    <div class="col-md-2">
                                                        <label for="dob" class="form-label">Date of Birth</label>
                                                        <input type="text" class="form-control" id="dob" placeholder="YYYY-MM-DD" v-model="Insuree.DOB">
                                                    </div>
                                                    
                                                    <div class="col-md-1" v-if="false">
                                                        <label for="isHead" class="form-check-label">IsHead</label>
                                                        <input type="checkbox" class="form-check-input" id="isHead" v-model="Insuree.IsHead" :disabled="true">
                                                    </div>

                                                    <div class="col-md-2">
                                                        <label for="gender" class="form-label">Gender</label>
                                                        <select class="form-select" v-model="Insuree.Gender">
                                                            <option value="">-- Select Gender --</option>
                                                            <option value="M">Male</option>
                                                            <option value="F">Female</option>
                                                            <option value="O">Other</option>
                                                        </select>
                                                    </div>

                                                    <div class="col-md-2">
                                                        <label for="maritalStatus" class="form-label">Marital Status</label>
                                                        <select class="form-select" v-model="Insuree.Marital">
                                                            <option value="">-- Select Status --</option>
                                                            <option value="M">Married</option>
                                                            <option value="S">Single</option>
                                                            <option value="D">Divorced</option>
                                                            <option value="W">Widowed</option>
                                                            <option value="N">Not specified</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <!-- /.Second Row -->

                                                <!-- Third Row -->
                                                <div class="row">
                                                    <div class="col-md-2">
                                                        <label for="typeofID" class="form-label">Type of ID</label>
                                                        <select class="form-select" v-model="Insuree.TypeOfId">
                                                            <option value="">--Select identity type--</option>
                                                            <option value="D">Driver's License</option>
                                                            <option value="N">National ID</option>
                                                            <option value="P">Passport</option>
                                                            <option value="V">Voter Card</option>
                                                        </select>
                                                    </div>

                                                    <div class="col-md-3">
                                                        <label for="passport" class="form-label">ID Number</label>
                                                        <input type="text" class="form-control" id="passport" placeholder="Passport" v-model="Insuree.passport">
                                                    </div>

                                                    <div class="col-md-3">
                                                        <label for="typeofIDFile" class="form-label">Type of ID File</label>
                                                        <input accept="image/x-png,image/gif,image/jpeg" class="form-control B64IdPhoto"  type="file" value="" @change="e => readURL(e,index,Insuree,'B64IdPhoto')"/>
                                                        <span class="field-validation-valid" data-valmsg-for="ImageFile" data-valmsg-replace="true"></span>
                                                        <img :src="Insuree.B64IdPhoto" class="img-responsive" style="width:250px;">
                                                    </div>

                                                    <div class="col-md-2" v-if="index!=0">
                                                        <label for="relationshipwithHead" class="form-label">Relationship with Head</label>
                                                        <select class="form-select" v-model="Insuree.Relationship">
                                                            <option value="0">--Select Relation--</option>
                                                            <option value="1">Brother/Sister</option>
                                                            <option value="2">Father/Mother</option>
                                                            <option value="3">Uncle/Aunt</option>
                                                            <option value="4">Son/Daughter</option>
                                                            <option value="5">Grand parents</option>
                                                            <option value="6">Employee</option>
                                                            <option value="7">Others</option>
                                                            <option value="8">Spouse</option>
                                                        </select>
                                                    </div>

                                                    <div class="col-md-2">
                                                        <label for="phone" class="form-label">Phone</label>
                                                        <input type="text" class="form-control" id="phone" placeholder="Phone Number" v-model="Insuree.Phone">
                                                    </div>
                                                </div>
                                                <!-- /.Third Row -->

                                                <!-- Fourth Row -->
                                                <div class="row">
                                                    <div class="col-md-2">
                                                        <label for="profession" class="form-label">Profession</label>
                                                        <select class="form-select" v-model="Insuree.Profession">
                                                            <option value="0">--Select Profession--</option>
                                                            <option value="1">Housewife</option>
                                                            <option value="2">Employee</option>
                                                            <option value="3">Self Employee</option>
                                                            <option value="4">Others</option>
                                                        </select>
                                                    </div>

                                                    <div class="col-md-2">
                                                        <label for="education" class="form-label">Education</label>
                                                        <select class="form-select" v-model="Insuree.Education">
                                                            <option value="1">Nursery</option>
                                                            <option value="2">Primary school</option>
                                                            <option value="3">Secondary school</option>
                                                            <option value="4">University</option>
                                                            <option value="5">Postgraduate studies</option>
                                                            <option value="6">PHD</option>
                                                            <option value="7">Other</option>
                                                        </select>
                                                    </div>

                                                    <div class="col-md-2">
                                                        <label for="email" class="form-label">Email</label>
                                                        <input type="email" class="form-control" id="email" placeholder="email@domain.com" v-model="Insuree.Email">
                                                    </div>
                                                    
                                                    <div class="col-md-3">
                                                        <label for="currentAddress" class="form-label">Current Address</label>
                                                        <input type="text" class="form-control" id="currentAddress" placeholder="Current Address" v-model="Insuree.CurrentAddress">
                                                    </div>

                                                    <div class="col-md-3">
                                                        <label class="form-label">Recent PP Size Photo</label>
                                                        <input accept="image/x-png,image/gif,image/jpeg" class="form-control InputFile" id="ImageFile" name="ImageFile" type="file" value="" @change="e => readURL(e,index,Insuree, 'B64Photo')"/>
                                                        <span class="field-validation-valid" data-valmsg-for="ImageFile" data-valmsg-replace="true"></span>
                                                        <img :id="'imgInsuree'+index" :src="Insuree.B64Photo" class="img-responsive" style="width:250px;">
                                                    </div>
                                                </div>
                                                <!-- /.Fourth Row -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- /.Family Details -->
                            </div>

                            <button type="button" class="btn btn-primary" @click="GuiNewInsuree" v-if="!IsApproveAllowed()">Add new family member</button>
                        </div>
                    </div>

                    <!-- Voucher Details -->
                    <div class="accordion my-3" id="accordionVoucher">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingVoucher">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVoucher" aria-expanded="true" aria-controls="collapseVoucher">
                                    Voucher Details
                                </button>
                            </h2>
                            <div id="collapseVoucher" class="accordion-collapse collapse show" aria-labelledby="headingVoucher" data-bs-parent="#accordionVoucher">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    Number of Members : 
                                                </div>
                                                <div class="col-md-4">
                                                    [[ Model.Insurees.length ]]
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    Total Amount : 
                                                </div>
                                                <div class="col-md-4">
                                                    NRs. <strong>[[ calulateAmount() ]]</strong>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-4">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label class="form-label">Voucher No : </label>
                                                </div>
                                                <div class="col-md-8">
                                                    <input type="text" class="form-control" name="voucher_no">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Upload Voucher</label>
                                            <input accept="image/x-png,image/gif,image/jpeg" class="form-control B64VoucherPhoto"  type="file" value="" @change="e => readURL(e,index,Model,'B64VoucherPhoto')"/>
                                            <span class="field-validation-valid" data-valmsg-for="ImageFile" data-valmsg-replace="true"></span>
                                            <img :src="Model.B64VoucherPhoto" class="img-responsive" style="width:250px;">
                                        </div>

                                        <div class="col-md-4 font-weight-bold">
                                        	<strong>
                                            <label class="form-label">Captcha</label>
                                            <div class="row">
                                                <div class="col-md-1">
                                                    [[a]]
                                                </div>

                                                <div class="col-md-1">
                                                    +
                                                </div>

                                                <div class="col-md-1">
                                                    [[b]]
                                                </div>

                                                <div class="col-md-4">
                                                    <input type="text" v-model="c" class="form-control">
                                                </div>
                                            </div>
                                        	</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /.Voucher Details -->
                </div>
            </div>
            <!-- /.Family Member Card -->
            <div class="row" v-if="IsApproveAllowed()">
                <div class="col-md-12">
                    <div class="form-check">
                        <input type="checkbox" v-model="app_submit.is_hold"  name="status" v-bind:value="true" id="flexCheckDefault">
                        <label class="form-check-label" for="flexCheckDefault">
                          keep in Hold [[app_submit.is_hold]]
                        </label>
                      </div>
                      <div class="form-check">
                        <input  type="checkbox" v-model="app_submit.is_rejected" v-bind:value="true" name="status" id="flexCheckChecked">
                        <label class="form-check-label" for="flexCheckChecked">
                          Reject application [[app_submit.is_rejected]]
                        </label> 
                      </div>

                      <div class="form-check">
                        <input  type="checkbox" v-model="app_submit.is_approved" v-bind:value="true"  name="status"id="flexCheckChecked">
                        <label class="form-check-label" for="flexCheckChecked">
                          approve application [[app_submit.is_approved]]
                        </label> 
                      </div>


                      <div class="form-control">
                        <input class="form-control" type="text" v-model="app_submit.status_message" value="" id="flexCheckChecked">
                       
                          Remarks [[app_submit.status_message]]
                       
                      </div>
                </div>
            </div>


            
            <div class="row">
                <div class="col-md-6">
                    <button type="button" class="btn btn-primary" @click="GuiSubmit" v-if="!IsApproveAllowed()">Submit</button>
                    <button type="button" class="btn btn-success" @click="GuiApprove" v-if="IsApproveAllowed()">Approve</button> 
                    <button type="button" class="btn btn-danger" @click="e=>{displayInitial=1; displayForm=0;}">Cancel</button>
                </div>
            </div>
            

        </div>        
    </div>  

                
    <input type='checkbox' v-model="Debug">
    <div class="container" v-if="Debug==1">
        <pre>
        [[ModelStatus]]
        [[ Selects ]]
        [[ Model ]]
        </pre>
    </div>
</div>

<script>
    Vue.use(VueLoading);
    // Vue.use(Toasted);
    // Vue.use(VueToast);
    // Window.prototype.$ToastSuccess = function (thisRef, msg) { 
    //             thisRef.$toasted.show(msg, { 
    //                             theme: "toasted-primary", 
    //                             position: "top-right", 
    //                             duration : 1500,
    //                             className: ['your-custom-class',]
    //                     });
                
    //          }

    Vue.component('loading', VueLoading);
    Window.prototype.$ShowLoading = function(thisRef){
            let loader = thisRef.$loading.show({
                loader: 'dots'
            });
            return loader;

        }
    new Vue({
        el: '#jpt',
        delimiters: ['[[', ']]'],
        data: {
            displayInitial:1,
            displayTracking:0,
            displayForm:0, 
        	Debug:0,
            app_submit : {
                is_approved : false,
                is_hold: false,
                is_rejected : false,
                status_message: ""
            },

            a : parseInt(Math.random() * 10),
            b : parseInt(Math.random()*10),
            c : 0,
            phone_number:"9849298499",
            Selects:{
                "Regions":[],
                "Locations":[],
                "FamilyTypes":[],
                "ConfirmationTypes":[],
  
                //"Family":[]
                "Gender":[],
                "Relationship":[],
                "Profession":[],
                "Education":[],
                "TypeOfId":[],
                "HFID":[]
            },
            "OrgExistingInsuree":{
                "CHFID":""
            },
            "OrgFamily":{
                //"FamilyID": "",
                //"FamilyUUID": "",
                //"InsureeID": "",
                "LocationId": "",
                "Poverty": false,
                //"ValidityFrom": "",
                //"ValidityTo": "",
                //"LegacyID": "",
                //"AuditUserID": "",
                //"RowID": "",
                "FamilyType": "H",
                "FamilyAddress": "Nepal",
                "isOffline": "",
                "Ethnicity": "",
                "ConfirmationNo": "",
                "ConfirmationType": ""
            },
            json_data:"",
            "OrgInsuree":{
                //"InsureeID": "",
                //"InsureeUUID": "",
                //"FamilyID": "",
                //"CHFID": "",
                "LastName": {val:"", req:1},
                "OtherNames": "",
                "DOB": {
                	val:"", req:1, 
                	fnVal: function(arg){ 
                		var valid=true;
                		if(arg.length<10){
                			alert('dob 10 digits required');
                			val=false;
                		}
                		return valid;
                	}
            	},
                "Gender": {val:"", req:1},
                "Marital": "",
                "IsHead": "",
                "passport": "",
                "Phone": "",
                 
                //"PhotoID": "",
                //"PhotoDate": "",
  
                //"CardIssued": "",
                //"ValidityFrom": "",
                //"ValidityTo": "",
                "LegacyID": "",
                //"AuditUserID": "",
                //"RowID": "",
                "Relationship": {val:"", req:0},
                "Profession": "",
                "Education": "",
                "Email": "",
                //"isOffline": "",
                //"TypeOfId": "",
                //"HFID": "",
                "CurrentAddress": {val:"", req:1},

                //"Geolocation": "",
                //"CurrentVillage": ""    

                "RegionId":"",  
                "B64Photo":{val:"", req: 1},
                "B64IdPhoto":{val:"", req: 1}
            },
            "Id":0,
            "decodeId":"",
            ModelStatus:{

            },
            Model: {
                "ExistingInsuree":{},
                "Family": {},
                "Insurees" :[]
            }
        }, //end data
        created() {
            console.log('created');
            this.Model.ExistingInsuree = JSON.parse(JSON.stringify(this.OrgExistingInsuree));
            this.Model.Family = JSON.parse(JSON.stringify(this.OrgFamily));
            this.getRegions();
            this.GuiNewInsuree();

            var id=this.getUrlParameter('id');
            if(id){
                this.displayInitial=0;
                this.displayForm=1;
                this.GetInsureeTempDetails({'id':id});
            }
            var decodeId=this.getUrlParameter('decodeId');
            if(decodeId){
                this.displayInitial=0;
                this.displayForm=1;
                this.decodeId=decodeId;
            }


        },
        mounted() {
            //for dbg
            window.submits=this.GuiSubmit;
            this.generateCaptch();
            if(this.app_submit.is_hold){
                this.app_submit.is_rejected = false;
            }
            if(this.app_submit.is_rejected){
                this.app_submit.is_hold = false;
            }
        },
        methods: {
            getUrlParameter(sParam) {
                console.log('getUrlParameter');
                var sPageURL = decodeURIComponent(window.location.search.substring(1)),
                    sURLVariables = sPageURL.split('&'),
                    sParameterName,
                    i;
                for (i = 0; i < sURLVariables.length; i++) {
                    sParameterName = sURLVariables[i].split('=');

                    if (sParameterName[0] === sParam) {
                        return sParameterName[1] === undefined ? true : sParameterName.slice(1).join('=');//base64 == fix
                    }
                }
            },
            getUrl(url){
                var u = this.getUrlParameter('server');
                if(u)
                {
                    return u+url;
                }
                return url;
            },
            IsApproveAllowed(){
                if(this.decodeId){
                    return true;
                }
                return false;
            },
            validateFamily(){
                var valid=true;

                return valid;
            },
            validateInsuree(Insuree){
                console.log('validateInsuree');
            	for(var k in this.OrgInsuree){
            		var curr = this.OrgInsuree[k]; 
            		if(typeof curr === 'object' && curr !== null) {
            			var req = curr['req'];
            			if(req==1) {
            				if(Insuree[k] =="" || Insuree[k]==null){
            					alert(`Insuree ${k} required`);
            					return false;
            				}
            			}
            			var fnVal=curr['fnVal'];
            			if(fnVal){
            				if( !fnVal(Insuree[k] ) ){
            					return false;
            				}
            			}
            		}
            	}
            	return true;
            },
            calulateAmount(){
                if(this.Model.Insurees.length <=5){
                    return 3500;
                }
                return (3500+ (this.Model.Insurees.length -5) * 700);

            },
            Validate(){
                var valid=true;
                var Insurees=this.Model.Insurees;
                for (var i = 0; i < Insurees.length; i++) {
                	if(!this.validateInsuree(Insurees[i])){
                		return false;
                	}
                }
                return valid;
            },
            GetOrgInsuree(){
            	var OrgInsuree={};
            	for(var k in this.OrgInsuree){
            		var curr = this.OrgInsuree[k]; 
            		OrgInsuree[k]=curr;
            		if(typeof curr === 'object' && curr !== null) {
            			OrgInsuree[k]=curr['val']
            		}
            	}
            	console.log(OrgInsuree);
            	return OrgInsuree;

            },
            HeadInsureeCopy(){
            	if(this.Model.Insurees.length > 0){
	            	if(this.Model.Insurees.length==1){ //IsHead selected for first insuree
	                    this.Model.Insurees[0].IsHead=1;
	                }
	                else {
	                    var lastInsuree=null; //this.Model.Insurees[this.Model.Insurees.length-1];
	                    var firstInsuree =this.Model.Insurees[0];
	                    for(var i=1; i<this.Model.Insurees.length; i++){ //assign head fields to all sub insuree
	                    	lastInsuree=this.Model.Insurees[i];
		                    lastInsuree.MunId = firstInsuree.MunId;
		                    lastInsuree.RegionId = firstInsuree.RegionId;
		                    lastInsuree.DistrictId = firstInsuree.DistrictId;
		                    lastInsuree.VillId = firstInsuree.VillId;
		                    lastInsuree.HFID = firstInsuree.HFID;
		                }
	                }
	            }
            },
            GuiNewInsuree(){
                this.Model.Insurees.push(
                    JSON.parse(JSON.stringify(this.GetOrgInsuree()))
                );
                this.HeadInsureeCopy();                
            },
            GetInsureeTempDetails(args){
                var thisRef = this;
                var id=args.id ? args.id : '';
                var phone_number=args.phone_number ? args.phone_number: '';
                var reqUrl = "/api/graphql";
                $.ajax({
                    url: reqUrl,
                    type: 'POST',
                    data:  JSON.stringify({
                        query: `{
                            #id: VGVtcG9yYXJ5UmVnR1FMVHlwZToxMDE1
                            tempregs(id: "${id}", phoneNumber: "${phone_number}"){
                                edges {
                                    node {
                                        json,
                                        isApproved,
                                        isHold,
                                        isRejected,
                                        statusMessage
                                    }
                                }
                            }
                        }`
                    }),//strData,
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    success: function (response) {
                        //console.log(response);
                        //var json_data = JSON.parse(response.data.tempreg.json); //tempreg api
                        var json_data = response.data.tempregs.edges[0].node;
                        Vue.set(thisRef, "ModelStatus", json_data);
                        Vue.set(thisRef, "Model", JSON.parse(json_data.json));
                    }
                }); //end ajax
            },
            generateCaptch(){
                this.a = parseInt(Math.random() * 10);
                this.b = parseInt(Math.random() * 10);
            },
            GuiSubmit(){
            	if(!this.Validate()){
            		return
            	}
                if(this.c!=(this.a+this.b)){
                    this.generateCaptch();
                    alert("Cpatch Wrong!!");
                    return;
                }
                let loader = $ShowLoading(this);
                var sendData = this.Model;
                var reqUrl = this.getUrl("/api/graphql");
                var strData = JSON.stringify( sendData ); // JSON.stringify( {"bla":"5"} );
                console.log(strData);
                $.ajax({
                    url: reqUrl,
                    type: 'POST',
                    data:  JSON.stringify({
                        query: `
                            mutation {
                                createTemporaryInsuree(json:${JSON.stringify(strData) }){
                                    ok
                                }
                            }`
                    }),//strData,
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    success: function (response) {
                        loader.hide();
                        // $ToastSuccess(this, 'Created New Bill');  
                        console.log(response);
                    }
                }); //end ajax                 
            },
            GuiApprove(){
                var id=this.getUrlParameter('decodeId');
                if(!id){
                    alert('no id');
                }
                if(!this.app_submit.is_rejected){
                    this.app_submit.is_rejected=false;
                }
                
                if(!this.app_submit.is_hold){
                    this.app_submit.is_hold=false;
                }
                
                if(!this.app_submit.is_approved){
                    this.app_submit.is_approved=false;
                }
                
                var reqUrl = this.getUrl("/api/graphql");
                $.ajax({
                    url: reqUrl,
                    type: 'POST',
                    data:  JSON.stringify({
                        query: `
                            mutation {
                                createInsureeMutationFromTemp(id:"${id}", 
                                        isHold: ${this.app_submit.is_hold}, 
                                        isRejected: ${this.app_submit.is_rejected},
                                        isApproved : ${this.app_submit.is_approved},
                                        statusMessage: "${this.app_submit.status_message}"){
                                    ok
                                    message
                                }
                            }`
                    }),
                    contentType: 'application/json; charset=utf-8',
                    success: function (response) {
                        console.log(response);
                    }
                }); //end ajax
            },
            getHealthFacility(args){
                var reqUrl = this.getUrl("/api/graphql");
                var location_Id=args.location_Id ? args.location_Id:'';
                $.ajax({
                    url: reqUrl,
                    type: 'POST',
                    data:  JSON.stringify({
                        query: `
                        query{
                            #TG9jYXRpb25HUUxUeXBlOjE5
                            healthFacilities(location_Id:"${location_Id}"){                            
                                edges{
                                    node{
                                        id,
                                        name,
                                        careType,
                                        code,
                                        location{
                                            id,
                                            name,
                                            type
                                        }
                                    }
                                }
                            }
                        }`
                    }),
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    success: function (response) {
                        console.log(response);
                        if(args.pRef){
                            var edges=response.data.healthFacilities.edges;
                            var options=[];
                            var node={};
                            for(var i=0; i<edges.length; i++){
                                node=edges[i].node;
                                options.push({'id': node['id'], 'name': node['name']});
                            }
                            Vue.set(
                                args.pRef, //parent Ref
                                args.cstr,  //childStr
                                options
                            );
                        }
                    }
                }); //end ajax 
            },
            getLocation(args){
                var reqUrl = this.getUrl("/api/graphql"); //"http://oi.tinker.com.np/api/graphql";
                var id=args.id ? args.id : '';
                var type=args.type ? args.type: '';
                var parent_Id=args.parent_Id ? args.parent_Id:'';
                $.ajax({
                    url: reqUrl,
                    type: 'POST',
                    data:  JSON.stringify({
                        query: `
                        query {
                            locations(id:"${id}", type:"${type}", parent_Id:"${parent_Id}"){
                                edges{
                                    node{
                                    id,
                                    type,
                                    name
                                    }
                                }
                            }
                        }`
                    }),
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    success: function (response) {
                        console.log(response);
                        if(args.pRef){
                            var edges=response.data.locations.edges;
                            var options=[];
                            var node={};
                            for(var i=0; i<edges.length; i++){
                                node=edges[i].node;
                                options.push({'id': node['id'], 'name': node['name']});
                            }
                            Vue.set(
                                args.pRef, //parent Ref
                                args.cstr,  //childStr
                                options
                            );
                        }
                    }
                }); //end ajax 
            },
            getRegions(){
                console.log('getRegions');
                this.getLocation({'id':'', 'type':'R', 'pRef': this.Selects, 'cstr': 'Regions'});
                this.HeadInsureeCopy();
            },
            changeRegion(Insuree){
                console.log(Insuree);
                Insuree.DistrictId="";
                this.getLocation({'parent_Id':Insuree.RegionId, 'pRef': Insuree, 'cstr': 'SelectDistricts'});
                this.HeadInsureeCopy();
            },
            changeDistrict(Insuree){
            	Insuree.MunId="";
            	Insuree.HFID="";
                this.getLocation({'parent_Id':Insuree.DistrictId, 'pRef': Insuree, 'cstr': 'SelectMuns'});
                this.getHealthFacility({'location_Id':Insuree.DistrictId, 'pRef': Insuree, 'cstr': 'SelectHealthFacility'});
                this.HeadInsureeCopy();
            },
            changeMun(Insuree){
            	Insuree.VillId="";
                this.getLocation({'parent_Id':Insuree.MunId, 'pRef': Insuree, 'cstr': 'SelectVillages'});
                this.HeadInsureeCopy();
            },
            readURL(evInput, index, Insuree, vModel){
                console.log('readURL');
                if (evInput.target.files && evInput.target.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        //$('#IdImageFileName').attr('src', e.target.result);

                        //console.log($('#IdImageFileName'));
                        //-----------------------------------
                        img = new Image();
                        img.onload = function () {
                            var allowedWidth = 500;
                            var allowedHeight = 300;

                            if (false && (this.width > allowedWidth || this.height > allowedHeight) ) {
                                $('#IdImageFileName').attr('src', '');
                                $('#ImageFile').val('');                        
                                alert(
                                    "The dimensions of image is : " + this.width + "x" + this.height +
                                    "! Only " + allowedHeight + "X" + allowedWidth +  " is allowed!"
                                );                        
                            }
                            else
                            {
                                //set image if dimension match
                                // $('#imgInsuree'+index).attr('src', e.target.result);
                                //Insuree["B64Photo"]=e.target.result; //not responsive but there is value set
                                // Vue.set(Insuree, 'B64Photo', e.target.result);
                                Vue.set(Insuree, vModel, e.target.result);
                                
                            }
                            
                        };

                        img.onerror = function () {
                            alert("not a valid file: " + file.type);
                        };
                        img.src = e.target.result;
                        //-----------------------------------

                    }
                    reader.readAsDataURL(evInput.target.files[0]);
                }
            }
        } //end methods
     }); //end Vue open
</script>

<!-- http://localhost:8055/api/webapp/temp_insuree_reg/?server=http://oi.tinker.com.np -->
<!-- http://localhost:8055/api/webapp/temp_insuree_reg/?server=http://localhost:8055 -->
</body>
</html>

